@{
    ViewData["Title"] = "Checkout";
    var clientSecret = ViewData["ClientSecret"] as string;
    var publishableKey = Context.RequestServices.GetRequiredService<IConfiguration>()["Stripe:PublishableKey"];
    var itemCount = ViewData["ItemCount"] ?? 0;
    var amountMajor = ViewData["AmountMajor"] ?? 0;
    var currency = (ViewData["Currency"] ?? "USD").ToString()?.ToUpper();
}

<div class="container my-5">
    <div class="row g-4">
        <!-- Payment Form -->
        <div class="col-lg-7">
            <div class="card shadow-lg p-4 rounded-3">
                <h3 class="fw-bold mb-3">ðŸ’³ Secure Checkout</h3>
                <p class="text-muted">Enter your payment details below to complete your purchase.</p>
                <hr />

                @if (!string.IsNullOrEmpty(clientSecret))
                {
                    <form id="payment-form">
                        <div id="payment-element" class="mb-3"></div>
                        <button id="pay-button" class="btn btn-success w-100 btn-lg">
                            Pay Now
                        </button>
                        <div id="payment-message" class="mt-3 text-danger small"></div>
                    </form>

                    <script src="https://js.stripe.com/v3/"></script>
                    <script>
                        const stripe = Stripe("@publishableKey");
                        const clientSecret = "@clientSecret";

                        const appearance = { theme: 'stripe' };
                        const elements = stripe.elements({ appearance, clientSecret });

                        const paymentElement = elements.create("payment");
                        paymentElement.mount("#payment-element");

                        document.getElementById("pay-button").addEventListener("click", async (e) => {
                            e.preventDefault();
                            document.getElementById("payment-message").innerText = "";

                            const { error } = await stripe.confirmPayment({
                                elements,
                                confirmParams: {
                                    return_url: window.location.origin + "/Checkout/Complete"
                                }
                            });

                            if (error) {
                                document.getElementById("payment-message").innerText = error.message;
                            }
                        });
                    </script>
                }
                else
                {
                    <form method="post" asp-action="PayAllConfirmed">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-primary w-100 btn-lg">
                            Initialize Payment
                        </button>
                    </form>
                }
            </div>
        </div>

        <!-- Order Summary -->
        <div class="col-lg-5">
            <div class="card shadow-sm p-4 rounded-3">
                <h5 class="fw-bold mb-3">ðŸ›’ Order Summary</h5>
                <div class="d-flex justify-content-between mb-2">
                    <span>Items (@itemCount)</span>
                    <span class="fw-semibold">@string.Format("{0:N2} {1}", amountMajor, currency)</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Shipping</span>
                    <span class="fw-semibold text-success">Free</span>
                </div>
                <hr />
                <div class="d-flex justify-content-between mb-3">
                    <span class="fw-bold">Total</span>
                    <span class="fw-bold text-success fs-5">
                        @string.Format("{0:N2} {1}", amountMajor, currency)
                    </span>
                </div>
                <div class="text-muted small">
                    Payments are secure and encrypted. We do not store your card details.
                </div>
            </div>
        </div>
    </div>
</div>
